; php.ini - Optimized for 27GB RAM & 8 CPU cores
; Production configuration with high performance settings

;;;;;;;;;;;;;;;;;;;;
; Engine & General ;
;;;;;;;;;;;;;;;;;;;;

engine = On
short_open_tag = Off
precision = 14
output_buffering = 4096
zlib.output_compression = Off
implicit_flush = Off
serialize_precision = -1
disable_functions = exec,passthru,shell_exec,system,popen,parse_ini_file,show_source
disable_classes =
allow_url_fopen = Off
allow_url_include = Off
variables_order = "EGPCS"
request_order = "GP"
register_argc_argv = Off
auto_globals_jit = On
post_max_size = 64M                   ; Increased for your resources
auto_prepend_file =
auto_append_file =
default_mimetype = "text/html"
default_charset = "UTF-8"
enable_dl = Off
file_uploads = Off                    ; Disabled: all uploads go to R2

;;;;;;;;;;;;;;;;;;;;
; Resource Limits ;
;;;;;;;;;;;;;;;;;;;;

max_execution_time = 30               ; Balanced for API operations
max_input_time = 60
max_input_nesting_level = 64
max_input_vars = 10000                ; Increased for complex forms
memory_limit = 512M                   ; Conservative per-request (27GB total)
realpath_cache_size = 32768K          ; Doubled for better performance
realpath_cache_ttl = 600              
upload_max_filesize = 1M              
max_file_uploads = 3                  

;;;;;;;;;;;;;;;;;;;;
; Error Handling ;
;;;;;;;;;;;;;;;;;;;;

display_errors = Off
display_startup_errors = Off
log_errors = On
log_errors_max_len = 1024
ignore_repeated_errors = On
ignore_repeated_source = On
report_memleaks = On
html_errors = Off
error_reporting = E_ALL & ~E_DEPRECATED & ~E_STRICT
error_log = /var/log/php/fpm-error.log

;;;;;;;;;;;;;;;;;;;;
; OPcache (Optimized for 27GB RAM) ;
;;;;;;;;;;;;;;;;;;;;

[opcache]
opcache.enable = 1
opcache.enable_cli = 1                
opcache.memory_consumption = 4096     ; 2GB for OPcache (plenty of headroom)
opcache.interned_strings_buffer = 64  ; Doubled for better string caching
opcache.max_accelerated_files = 100000; Very high for large codebases
opcache.max_wasted_percentage = 5
opcache.use_cwd = 1
opcache.validate_timestamps = 0       ; Off in production
opcache.revalidate_freq = 0
opcache.fast_shutdown = 1             
opcache.save_comments = 1             
opcache.load_comments = 1
opcache.enable_file_override = 1      ; Enabled for performance
opcache.optimization_level = 0x7FFFBFFF
opcache.max_file_size = 2048          ; Cache larger files (2MB)
opcache.file_cache = /tmp/opcache     ; Second level cache
opcache.file_cache_only = 0
opcache.file_cache_consistency_checks = 0
opcache.huge_code_pages = 1           ; Use huge pages for better TLB
opcache.preload_user = www-data
opcache.jit = tracing                 ; JIT enabled (PHP 8+)
opcache.jit_buffer_size = 512M        ; JIT buffer allocation

;;;;;;;;;;;;;;;;;;;;
; APCu Cache (User Cache) ;
;;;;;;;;;;;;;;;;;;;;

[apcu]
apc.enabled = 1
apc.shm_size = 1G                   ; 512MB for user cache
apc.ttl = 7200
apc.user_ttl = 7200
apc.num_files_hint = 10000
apc.user_entries_hint = 10000
apc.gc_ttl = 3600
apc.enable_cli = 1
apc.use_request_time = 0
apc.coredump_unmap = 0
apc.preload_path =

;;;;;;;;;;;;;;;;;;;;
; Session Settings ;
;;;;;;;;;;;;;;;;;;;;

[Session]
session.save_handler = redis
session.save_path = "tcp://redis:6379?auth=bodo136379&database=0"
session.use_strict_mode = 1
session.use_cookies = 1
session.use_only_cookies = 1
session.name = PHPSESSID
session.auto_start = 0
session.cookie_lifetime = 0
session.cookie_path = /
session.cookie_domain =
session.cookie_secure = 1               
session.cookie_httponly = 1             
session.cookie_samesite = Lax           
session.gc_probability = 1
session.gc_divisor = 1000
session.gc_maxlifetime = 14400          
session.referer_check =
session.cache_limiter = nocache
session.cache_expire = 180
session.use_trans_sid = 0
session.sid_length = 48                ; Increased for better security
session.sid_bits_per_character = 6     ; More entropy

;;;;;;;;;;;;;;;;;;;;
; Redis Extension ;
;;;;;;;;;;;;;;;;;;;;

[redis]
redis.arrays.retryinterval = 10
redis.clusters.cache_slots = 1
redis.clusters.auth = bodo136379
redis.clusters.persistent = 1
redis.clusters.read_timeout = 2
redis.clusters.timeout = 2
redis.pconnect.pooling_enabled = 1
redis.pconnect.connection_limit = 100  ; Pool connections
redis.session.locking_enabled = 1
redis.session.lock_expire = 30
redis.session.lock_retries = 100
redis.session.lock_wait_time = 20000

;;;;;;;;;;;;;;;;;;;;
; Database ;
;;;;;;;;;;;;;;;;;;;;

[MySQLi]
mysqli.max_persistent = 50             ; Persistent connections pool
mysqli.allow_persistent = On
mysqli.max_links = 100                 ; Total connections
mysqli.cache_size = 4000
mysqli.default_port = 3306
mysqli.reconnect = Off
mysqli.rollback_on_cached_plink = Off

[PDO]
pdo_mysql.cache_size = 2000
pdo_mysql.default_socket =

;;;;;;;;;;;;;;;;;;;;
; Mail Settings ;
;;;;;;;;;;;;;;;;;;;;

[mail function]
SMTP = localhost
smtp_port = 25
mail.add_x_header = Off
sendmail_path = /usr/sbin/sendmail -t -i

;;;;;;;;;;;;;;;;;;;;
; Performance Tuning ;
;;;;;;;;;;;;;;;;;;;;

; Process Manager (for FPM)
; These would go in www.conf but including for reference
pm = dynamic
pm.max_children = 200                ; (27GB / 512MB) safe margin
pm.start_servers = 20                ; 8 cores * 2.5
pm.min_spare_servers = 10
pm.max_spare_servers = 30
pm.max_requests = 1000               ; Recycle workers periodically
pm.process_idle_timeout = 10s

;;;;;;;;;;;;;;;;;;;;
; Additional Performance ;
;;;;;;;;;;;;;;;;;;;;

; PCRE JIT for faster regex
pcre.jit = 1
pcre.backtrack_limit = 2M
pcre.recursion_limit = 100000

; Assertions off in production
zend_gc_enable = Off
zend.assertions = -1
assert.active = 0

; Output compression
zlib.output_compression_level = 6

; Multibyte string optimization
mbstring.func_overload = 0

;;;;;;;;;;;;;;;;;;;;
; Extensions to Load ;
;;;;;;;;;;;;;;;;;;;;

; Ensure these are installed
; extension=redis
; extension=apcu
; extension=igbinary
; extension=mysqli
; extension=pdo_mysql
; extension=opcache
; extension=zip
; extension=gd
; extension=mbstring
; extension=curl
; extension=json
; extension=xml

;;;;;;;;;;;;;;;;;;;;
; Notes ;
;;;;;;;;;;;;;;;;;;;;

; Optimized for 27GB RAM & 8 cores:
; - OPcache: 2GB allocation with JIT enabled
; - APCu: 512MB for user cache
; - Memory limit: 512MB per request (safe with ~50 concurrent)
; - Redis: Connection pooling enabled
; - MySQL: Persistent connections with pooling
; - File caches: Huge pages enabled for better TLB
;
; Performance tips:
; - Clear OPcache on deploy: php -r "opcache_reset();"
; - Monitor with: php -r "print_r(opcache_get_status());"
; - APCu stats: php -r "print_r(apcu_cache_info());"
;
; Expected capacity:
; - ~50-100 concurrent PHP processes
; - ~100K+ requests/minute capability
; - Sub-10ms response times for cached content